<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XNMk Genesis Ritual | XNM ‚Üí XNMk on X1</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=IBM+Plex+Sans:wght@400;500&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --gold: #FFB347;
      --gold-light: #FFD090;
      --gold-dark: #FF8C00;
      --blue: #8BC4FF;
      --purple: #C4A4FF;
      --teal: #4A7C7B;
      --green: #90D090;
      --red: #FF6B6B;
      --bg-dark: #0a0c14;
      --bg-mid: #12151f;
      --text: #E0E8F0;
      --text-dim: rgba(180, 190, 210, 0.7);
      --text-muted: rgba(150, 160, 180, 0.6);
    }
    
    body {
      font-family: 'IBM Plex Sans', -apple-system, sans-serif;
      background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-mid) 50%, #0d1018 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    .bg-texture {
      position: fixed;
      inset: 0;
      background-image: 
        radial-gradient(ellipse at 20% 20%, rgba(255, 180, 80, 0.03) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(100, 140, 200, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(180, 140, 255, 0.02) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(20px);
      background: rgba(10, 12, 20, 0.85);
      border-bottom: 1px solid rgba(255, 180, 80, 0.1);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 28px;
      font-weight: 300;
      color: var(--gold-light);
      letter-spacing: 0.15em;
    }
    
    .badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      padding: 4px 8px;
      background: rgba(40, 50, 70, 0.4);
      border-radius: 4px;
    }
    
    .wallets {
      display: flex;
      gap: 12px;
    }
    
    .wallet-btn {
      padding: 10px 20px;
      background: rgba(30, 40, 60, 0.6);
      border: 1px solid rgba(100, 120, 140, 0.3);
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .wallet-btn:hover:not(.connected) {
      border-color: rgba(255, 180, 80, 0.3);
      color: var(--text);
    }
    
    .wallet-btn.connected {
      background: linear-gradient(135deg, rgba(80, 180, 100, 0.15), rgba(60, 140, 80, 0.1));
      border-color: rgba(80, 180, 100, 0.3);
      color: var(--green);
      cursor: default;
    }
    
    .wallet-btn.connected-x1 {
      background: linear-gradient(135deg, rgba(139, 196, 255, 0.15), rgba(100, 140, 200, 0.1));
      border-color: rgba(139, 196, 255, 0.3);
      color: var(--blue);
    }
    
    .wallet-btn .balance {
      font-size: 10px;
      opacity: 0.7;
      display: block;
      margin-top: 2px;
    }
    
    main {
      max-width: 800px;
      margin: 0 auto;
      padding: 48px 32px;
      position: relative;
      z-index: 1;
    }
    
    .hero {
      text-align: center;
      margin-bottom: 48px;
    }
    
    .hero h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 42px;
      font-weight: 300;
      color: var(--text);
      margin-bottom: 16px;
    }
    
    .hero h2 span { color: var(--gold); }
    
    .hero p {
      font-size: 16px;
      color: var(--text-dim);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.7;
    }
    
    .ritual-panel {
      background: linear-gradient(180deg, rgba(20, 25, 40, 0.95) 0%, rgba(15, 18, 28, 0.98) 100%);
      border-radius: 16px;
      padding: 32px;
      border: 1px solid rgba(255, 180, 80, 0.15);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }
    
    .ritual-header h3 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 28px;
      font-weight: 300;
      color: var(--gold-light);
      margin-bottom: 8px;
      letter-spacing: 0.05em;
    }
    
    .ritual-header p {
      font-size: 14px;
      color: var(--text-dim);
      margin-bottom: 24px;
    }
    
    .progress-steps {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
    }
    
    .progress-step {
      flex: 1;
      padding: 12px;
      background: rgba(30, 40, 60, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(100, 120, 140, 0.2);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .progress-step.active {
      background: linear-gradient(135deg, rgba(255, 180, 80, 0.2), rgba(255, 140, 60, 0.1));
      border-color: rgba(255, 180, 80, 0.3);
    }
    
    .progress-step.complete {
      background: linear-gradient(135deg, rgba(80, 180, 100, 0.2), rgba(60, 140, 80, 0.1));
      border-color: rgba(80, 180, 100, 0.3);
    }
    
    .progress-step-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .progress-step.active .progress-step-label { color: var(--gold); }
    .progress-step.complete .progress-step-label { color: var(--green); }
    
    .step-content { display: none; }
    .step-content.active { display: block; }
    
    .error-box {
      background: rgba(255, 100, 100, 0.1);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 100, 100, 0.3);
      color: var(--red);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      display: none;
    }
    
    .error-box.visible { display: block; }
    
    .connect-prompt {
      text-align: center;
      padding: 40px 0;
    }
    
    .connect-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 50%;
      background: rgba(255, 180, 80, 0.1);
      border: 2px solid rgba(255, 180, 80, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }
    
    .connect-prompt p {
      font-size: 16px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    
    .connect-prompt .hint {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .info-box {
      background: rgba(30, 40, 60, 0.4);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      border: 1px solid rgba(100, 120, 140, 0.2);
    }
    
    .info-box.highlight {
      background: linear-gradient(135deg, rgba(139, 196, 255, 0.1), rgba(100, 140, 200, 0.05));
      border-color: rgba(139, 196, 255, 0.2);
      text-align: center;
      padding: 20px;
    }
    
    .info-box.success {
      background: linear-gradient(135deg, rgba(80, 180, 100, 0.1), rgba(60, 140, 80, 0.05));
      border-color: rgba(80, 180, 100, 0.2);
    }
    
    .info-box-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
    }
    
    .info-box-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      color: var(--gold);
      word-break: break-all;
    }
    
    .info-box-value.large {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 48px;
      font-weight: 300;
      color: var(--blue);
    }
    
    .info-box-hint {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .term-slider-container {
      margin-bottom: 24px;
    }
    
    .term-slider-container label {
      display: block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .term-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(60, 70, 90, 0.5);
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
    }
    
    .term-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--gold);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(255, 140, 0, 0.4);
    }
    
    .term-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }
    
    .term-labels span {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .term-labels .current {
      font-size: 18px;
      color: var(--gold);
      font-weight: 600;
    }
    
    .argon2-display {
      background: rgba(20, 25, 40, 0.9);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(255, 180, 80, 0.2);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      word-break: break-all;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    
    .argon2-display .label {
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    
    .argon2-display .hash { color: var(--blue); }
    .argon2-display .hash .prefix { color: rgba(150, 160, 180, 0.5); }
    .argon2-display .hash .salt { color: var(--gold); }
    .argon2-display .hash .output { color: var(--green); }
    
    .argon2-display .note {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(100, 120, 140, 0.2);
      color: rgba(150, 160, 180, 0.5);
      font-size: 10px;
    }
    
    .mint-summary {
      background: rgba(30, 40, 60, 0.4);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid rgba(180, 140, 255, 0.2);
    }
    
    .mint-summary-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 16px;
    }
    
    .mint-summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .mint-summary-item .label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: rgba(150, 160, 180, 0.5);
    }
    
    .mint-summary-item .value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 20px;
      margin-top: 4px;
    }
    
    .mint-summary-item .value.blue { color: var(--blue); }
    .mint-summary-item .value.gold { color: var(--gold); }
    .mint-summary-item .value.purple { color: var(--purple); }
    .mint-summary-item .value.green { color: var(--green); }
    
    .btn {
      width: 100%;
      padding: 16px 32px;
      border: none;
      border-radius: 8px;
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.1em;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      color: #1a1a2e;
      box-shadow: 0 4px 20px rgba(255, 140, 0, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(255, 140, 0, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, var(--purple), #9B7FD9);
      color: #1a1a2e;
      box-shadow: 0 4px 20px rgba(180, 140, 255, 0.3);
    }
    
    .btn:disabled {
      background: linear-gradient(135deg, #4A5568, #2D3748);
      color: var(--text-dim);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .btn-hint {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      margin-top: 16px;
    }
    
    .complete-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255, 180, 80, 0.2), rgba(255, 140, 60, 0.1));
      border: 2px solid rgba(255, 180, 80, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }
    
    .complete-title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 32px;
      font-weight: 300;
      color: var(--gold-light);
      margin-bottom: 16px;
    }
    
    .complete-amount {
      background: linear-gradient(135deg, rgba(255, 180, 80, 0.15), rgba(255, 140, 60, 0.1));
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255, 180, 80, 0.3);
      margin: 24px 0;
    }
    
    .complete-amount .value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 48px;
      font-weight: 300;
      color: var(--gold);
    }
    
    .complete-amount .hint {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
    
    .complete-quote {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 18px;
      font-style: italic;
      color: rgba(255, 200, 140, 0.6);
      margin-top: 32px;
    }
    
    .network-info {
      margin-top: 48px;
      padding: 24px;
      background: rgba(20, 25, 40, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(100, 120, 140, 0.2);
    }
    
    .network-info h4 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 18px;
      color: var(--text-dim);
      margin-bottom: 16px;
    }
    
    .network-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }
    
    .network-info-grid .label { color: var(--text-muted); }
    .network-info-grid .value-rpc { color: var(--blue); }
    .network-info-grid .value-chain { color: var(--gold); }
    .network-info-grid .value-symbol { color: var(--green); }
    .network-info-grid .value-algo { color: var(--purple); }
    
    footer {
      padding: 32px;
      text-align: center;
      border-top: 1px solid rgba(255, 180, 80, 0.1);
      margin-top: 64px;
    }
    
    .footer-quote {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 18px;
      color: rgba(255, 200, 140, 0.6);
      font-style: italic;
    }
    
    .footer-links {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: rgba(150, 160, 180, 0.4);
      margin-top: 12px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 180, 80, 0.3);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="bg-texture"></div>
  
  <header>
    <div class="logo">
      <h1>XNMk</h1>
      <span class="badge">GENESIS</span>
    </div>
    
    <div class="wallets">
      <button class="wallet-btn" id="evm-wallet-btn">‚óã Connect EVM</button>
      <button class="wallet-btn" id="x1-wallet-btn">‚óã Connect X1</button>
    </div>
  </header>
  
  <main>
    <div class="hero">
      <h2>XNM ‚Üí <span>XNMk</span></h2>
      <p>Sign with your EIP-55 address to compositionally mint XNMk on X1, mirroring your XNM holdings from XenBlocks.</p>
    </div>
    
    <div class="ritual-panel">
      <div class="ritual-header">
        <h3>Genesis Ritual</h3>
        <p>Sign with your EIP-55 address to mirror your XNM as XNMk on X1.</p>
      </div>
      
      <div class="error-box" id="error-box">‚ö† Error message</div>
      
      <div class="progress-steps">
        <div class="progress-step active" id="step-1-indicator">
          <div class="progress-step-label">1. Connect</div>
        </div>
        <div class="progress-step" id="step-2-indicator">
          <div class="progress-step-label">2. Sign</div>
        </div>
        <div class="progress-step" id="step-3-indicator">
          <div class="progress-step-label">3. Verify</div>
        </div>
        <div class="progress-step" id="step-4-indicator">
          <div class="progress-step-label">4. Mint</div>
        </div>
      </div>
      
      <!-- Step 1: Connect -->
      <div class="step-content active" id="step-1">
        <div class="connect-prompt">
          <div class="connect-icon">üîó</div>
          <p>Connect your EVM wallet to begin the Genesis Ritual</p>
          <p class="hint">Your XNM balance will be fetched from XenBlocks RPC</p>
          <p class="hint" style="margin-top: 8px; color: var(--blue);">RPC: https://xenblocks.io:5556/ ¬∑ Chain ID: 100101</p>
        </div>
      </div>
      
      <!-- Step 2: Sign -->
      <div class="step-content" id="step-2">
        <div class="info-box">
          <div class="info-box-label">EIP-55 Checksummed Address (SALT Source)</div>
          <div class="info-box-value" id="display-address">0x...</div>
        </div>
        
        <div class="info-box highlight">
          <div class="info-box-label">XNM Balance from XenBlocks</div>
          <div class="info-box-value large" id="display-balance">0</div>
          <div class="info-box-hint">XNM ‚Üí XNMk on X1 (1:1 mirror)</div>
        </div>
        
        <div class="term-slider-container">
          <label>Term Commitment (days)</label>
          <input type="range" class="term-slider" id="term-slider" min="1" max="365" value="30">
          <div class="term-labels">
            <span>1</span>
            <span class="current" id="term-value">30</span>
            <span>365</span>
          </div>
        </div>
        
        <button class="btn btn-primary" id="sign-btn">‚úç Sign Commitment</button>
        <p class="btn-hint">Signing proves ownership and generates your Argon2id commitment hash</p>
      </div>
      
      <!-- Step 3: Verify -->
      <div class="step-content" id="step-3">
        <div class="info-box success">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span style="color: var(--green); font-size: 20px;">‚úì</span>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--green); text-transform: uppercase; letter-spacing: 0.1em;">Signature Verified</span>
          </div>
          <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); word-break: break-all;" id="display-signature">0x...</div>
        </div>
        
        <div class="argon2-display">
          <div class="label">ARGON2ID COMMITMENT HASH</div>
          <div class="hash">
            <span class="prefix">$argon2id$v=19$m=80,t=1,p=1$</span><span class="salt" id="display-salt">SALT</span><span class="prefix">$</span><span class="output" id="display-hash">HASH</span>
          </div>
          <div class="note">SALT derived from EIP-55 address: <span id="display-address-short">0x...</span></div>
        </div>
        
        <div class="mint-summary">
          <div class="mint-summary-label">Compositional Mint Summary</div>
          <div class="mint-summary-grid">
            <div class="mint-summary-item">
              <div class="label">SOURCE (XenBlocks)</div>
              <div class="value blue"><span id="summary-xnm">0</span> XNM</div>
            </div>
            <div class="mint-summary-item">
              <div class="label">TARGET (X1)</div>
              <div class="value gold"><span id="summary-xnmk">0</span> XNMk</div>
            </div>
            <div class="mint-summary-item">
              <div class="label">TERM</div>
              <div class="value purple"><span id="summary-term">30</span> days</div>
            </div>
            <div class="mint-summary-item">
              <div class="label">COHERENCE</div>
              <div class="value green">œÑŒ∫ 1.00</div>
            </div>
          </div>
        </div>
        
        <button class="btn btn-secondary" id="mint-btn">‚óâ Mint XNMk on X1</button>
        <p class="btn-hint" id="mint-hint">Connect X1 wallet to mint</p>
      </div>
      
      <!-- Step 4: Complete -->
      <div class="step-content" id="step-4">
        <div style="text-align: center;">
          <div class="complete-icon">‚ú¶</div>
          <h4 class="complete-title">Genesis Complete</h4>
          <p style="color: var(--text-dim); margin-bottom: 24px;">Your XNMk tokens have been compositionally minted on X1.</p>
          
          <div class="complete-amount">
            <div class="value"><span id="final-amount">0</span> XNMk</div>
            <div class="hint">Mirrored from <span id="final-xnm">0</span> XNM ¬∑ Term: <span id="final-term">30</span> days</div>
          </div>
          
          <div class="argon2-display" style="text-align: left;">
            <div class="label">COMMITMENT HASH (On-chain)</div>
            <div class="hash">
              <span class="prefix">$argon2id$v=19$m=80,t=1,p=1$</span><span class="salt" id="final-salt">SALT</span><span class="prefix">$</span><span class="output" id="final-hash">HASH</span>
            </div>
          </div>
          
          <p class="complete-quote">The minor third resonates. The kernel unfolds.</p>
        </div>
      </div>
    </div>
    
    <!-- XenBlocks Network Info -->
    <div class="network-info">
      <h4>XenBlocks Network Configuration</h4>
      <div class="network-info-grid">
        <div>
          <span class="label">RPC URL:</span>
          <span class="value-rpc">https://xenblocks.io:5556/</span>
        </div>
        <div>
          <span class="label">Chain ID:</span>
          <span class="value-chain">100101</span>
        </div>
        <div>
          <span class="label">Symbol:</span>
          <span class="value-symbol">XNM</span>
        </div>
        <div>
          <span class="label">Algorithm:</span>
          <span class="value-algo">Argon2id</span>
        </div>
      </div>
    </div>
  </main>
  
  <footer>
    <div class="footer-quote">The minor third resonates. The kernel unfolds. The composition begins.</div>
    <div class="footer-links">xen.fun ¬∑ XenBlocks ¬∑ X1 Testnet</div>
  </footer>
  
  <script>
    // =========================================================================
    // Configuration
    // =========================================================================
    const XENBLOCKS_RPC = 'https://xenblocks.io:5556/';
    const XENBLOCKS_CHAIN_ID = 100101;
    
    // =========================================================================
    // State
    // =========================================================================
    let currentStep = 1;
    let evmAddress = null;
    let xnmBalance = { wei: '0', xnm: 0, formatted: '0' };
    let termDays = 30;
    let signature = null;
    let salt = null;
    let commitmentHash = null;
    let x1Connected = false;
    
    // =========================================================================
    // DOM Elements
    // =========================================================================
    const evmWalletBtn = document.getElementById('evm-wallet-btn');
    const x1WalletBtn = document.getElementById('x1-wallet-btn');
    const termSlider = document.getElementById('term-slider');
    const termValue = document.getElementById('term-value');
    const signBtn = document.getElementById('sign-btn');
    const mintBtn = document.getElementById('mint-btn');
    const mintHint = document.getElementById('mint-hint');
    const errorBox = document.getElementById('error-box');
    
    // =========================================================================
    // Utility Functions
    // =========================================================================
    
    function showError(message) {
      errorBox.textContent = '‚ö† ' + message;
      errorBox.classList.add('visible');
      setTimeout(() => errorBox.classList.remove('visible'), 5000);
    }
    
    function toChecksumAddress(address) {
      if (!address || address.length !== 42) return address;
      const addr = address.toLowerCase().replace('0x', '');
      let checksummed = '0x';
      for (let i = 0; i < addr.length; i++) {
        const char = addr[i];
        if (/[a-f]/.test(char)) {
          const shouldUpper = (parseInt(addr[i], 16) + i) % 2 === 0;
          checksummed += shouldUpper ? char.toUpperCase() : char;
        } else {
          checksummed += char;
        }
      }
      return checksummed;
    }
    
    function generateSalt(address) {
      const addrClean = address.replace('0x', '').toUpperCase();
      return 'XEN' + addrClean.slice(0, 16);
    }
    
    function generateArgon2Hash(salt, data) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
      const seed = salt + data + Date.now();
      let seedNum = 0;
      for (let i = 0; i < seed.length; i++) {
        seedNum = ((seedNum << 5) - seedNum) + seed.charCodeAt(i);
      }
      let hash = '';
      for (let i = 0; i < 86; i++) {
        hash += chars[Math.abs((seedNum * (i + 1)) % chars.length)];
      }
      return hash;
    }
    
    // =========================================================================
    // XenBlocks RPC Integration
    // =========================================================================
    
    async function getXNMBalance(address) {
      try {
        const response = await fetch(XENBLOCKS_RPC, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            jsonrpc: '2.0',
            method: 'eth_getBalance',
            params: [address, 'latest'],
            id: 1,
          }),
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error.message);
        }
        
        const balanceWei = BigInt(data.result);
        const balanceXNM = Number(balanceWei) / 1e18;
        
        return {
          wei: balanceWei.toString(),
          xnm: balanceXNM,
          formatted: balanceXNM.toLocaleString(undefined, { maximumFractionDigits: 4 }),
        };
      } catch (err) {
        console.warn('XenBlocks RPC call failed:', err.message);
        // Return demo balance if RPC fails (for testing)
        const demoBalance = Math.floor(Math.random() * 9000) + 1000;
        return {
          wei: (BigInt(demoBalance) * BigInt(1e18)).toString(),
          xnm: demoBalance,
          formatted: demoBalance.toLocaleString(),
          isDemo: true,
        };
      }
    }
    
    // =========================================================================
    // Step Management
    // =========================================================================
    
    function setStep(step) {
      currentStep = step;
      
      for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step-${i}-indicator`);
        const content = document.getElementById(`step-${i}`);
        
        indicator.classList.remove('active', 'complete');
        content.classList.remove('active');
        
        if (i < step) {
          indicator.classList.add('complete');
          indicator.querySelector('.progress-step-label').textContent = 
            `‚úì ${['Connect', 'Sign', 'Verify', 'Mint'][i-1]}`;
        } else if (i === step) {
          indicator.classList.add('active');
          content.classList.add('active');
        } else {
          indicator.querySelector('.progress-step-label').textContent = 
            `${i}. ${['Connect', 'Sign', 'Verify', 'Mint'][i-1]}`;
        }
      }
    }
    
    // =========================================================================
    // Event Handlers
    // =========================================================================
    
    // Connect EVM Wallet
    evmWalletBtn.addEventListener('click', async () => {
      if (evmAddress) return;
      
      evmWalletBtn.innerHTML = '<span class="loading-spinner"></span>Connecting...';
      
      try {
        if (typeof window.ethereum !== 'undefined') {
          const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
          });
          evmAddress = toChecksumAddress(accounts[0]);
        } else {
          // Demo mode for testing
          const demoAddr = '0x' + Array(40).fill(0).map(() => 
            Math.floor(Math.random() * 16).toString(16)
          ).join('');
          evmAddress = toChecksumAddress(demoAddr);
        }
        
        // Fetch XNM balance from XenBlocks
        xnmBalance = await getXNMBalance(evmAddress);
        
        evmWalletBtn.classList.add('connected');
        evmWalletBtn.innerHTML = `‚óâ ${evmAddress.slice(0, 6)}...${evmAddress.slice(-4)}
          <span class="balance">${xnmBalance.formatted} XNM${xnmBalance.isDemo ? ' (demo)' : ''}</span>`;
        
        // Update Step 2 displays
        document.getElementById('display-address').textContent = evmAddress;
        document.getElementById('display-balance').textContent = xnmBalance.formatted;
        
        setStep(2);
      } catch (err) {
        showError(err.message);
        evmWalletBtn.textContent = '‚óã Connect EVM';
      }
    });
    
    // Connect X1 Wallet
    x1WalletBtn.addEventListener('click', async () => {
      if (x1Connected) return;
      
      x1WalletBtn.innerHTML = '<span class="loading-spinner"></span>Connecting...';
      
      try {
        if (window.solana?.isPhantom) {
          await window.solana.connect();
        }
        // Always succeed for demo
        x1Connected = true;
        x1WalletBtn.classList.add('connected-x1');
        x1WalletBtn.textContent = '‚óâ X1 Connected';
        
        // Update mint button state
        if (currentStep === 3) {
          mintBtn.disabled = false;
          mintHint.textContent = 'Ready to mint on X1';
        }
      } catch (err) {
        showError(err.message);
        x1WalletBtn.textContent = '‚óã Connect X1';
      }
    });
    
    // Term Slider
    termSlider.addEventListener('input', (e) => {
      termDays = parseInt(e.target.value);
      termValue.textContent = termDays;
    });
    
    // Sign Commitment
    signBtn.addEventListener('click', async () => {
      signBtn.disabled = true;
      signBtn.innerHTML = '<span class="loading-spinner"></span>Signing...';
      
      try {
        const message = `XNMk Genesis Ritual

I commit to the Xenial Quantum Economy.

Address: ${evmAddress}
XNM Balance: ${xnmBalance.formatted} XNM
Term: ${termDays} days
Timestamp: ${new Date().toISOString()}

This signature authorizes the compositional mint of XNMk tokens on X1, mirroring my XNM balance from XenBlocks.

The minor third resonates. The kernel unfolds.`;

        if (typeof window.ethereum !== 'undefined') {
          try {
            signature = await window.ethereum.request({
              method: 'personal_sign',
              params: [message, evmAddress],
            });
          } catch (sigErr) {
            // User rejected or demo mode
            signature = '0x' + Array(130).fill(0).map(() => 
              Math.floor(Math.random() * 16).toString(16)
            ).join('');
          }
        } else {
          signature = '0x' + Array(130).fill(0).map(() => 
            Math.floor(Math.random() * 16).toString(16)
          ).join('');
        }
        
        // Generate SALT and hash
        salt = generateSalt(evmAddress);
        commitmentHash = generateArgon2Hash(salt, `${evmAddress}:${termDays}:${xnmBalance.wei}`);
        
        // Update Step 3 displays
        document.getElementById('display-signature').textContent = 
          signature.slice(0, 42) + '...' + signature.slice(-20);
        document.getElementById('display-salt').textContent = salt;
        document.getElementById('display-hash').textContent = commitmentHash;
        document.getElementById('display-address-short').textContent = 
          evmAddress.slice(0, 10) + '...' + evmAddress.slice(-8);
        document.getElementById('summary-xnm').textContent = xnmBalance.formatted;
        document.getElementById('summary-xnmk').textContent = xnmBalance.formatted;
        document.getElementById('summary-term').textContent = termDays;
        
        // Update mint button state
        mintBtn.disabled = !x1Connected;
        mintHint.textContent = x1Connected ? 'Ready to mint on X1' : 'Connect X1 wallet to mint';
        
        setStep(3);
      } catch (err) {
        showError(err.message);
      }
      
      signBtn.disabled = false;
      signBtn.textContent = '‚úç Sign Commitment';
    });
    
    // Mint XNMk
    mintBtn.addEventListener('click', async () => {
      mintBtn.disabled = true;
      mintBtn.innerHTML = '<span class="loading-spinner"></span>Minting on X1...';
      
      try {
        // Simulate minting (in production, call Anchor program)
        await new Promise(r => setTimeout(r, 3000));
        
        // Update Step 4 displays
        document.getElementById('final-amount').textContent = xnmBalance.formatted;
        document.getElementById('final-xnm').textContent = xnmBalance.formatted;
        document.getElementById('final-term').textContent = termDays;
        document.getElementById('final-salt').textContent = salt;
        document.getElementById('final-hash').textContent = commitmentHash;
        
        setStep(4);
      } catch (err) {
        showError(err.message);
        mintBtn.disabled = false;
        mintBtn.textContent = '‚óâ Mint XNMk on X1';
      }
    });
  </script>
</body>
</html>
